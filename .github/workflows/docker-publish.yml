name: Build and Deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      frontend-tag: ${{ steps.meta.outputs.frontend-tag }}
      backend-tag: ${{ steps.meta.outputs.backend-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags and environment
        id: meta
        run: |
          # Determine version and environment
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
            ENV="production"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            VERSION="pr-${{ github.event.pull_request.number }}"
            ENV="integration"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="latest"
            ENV="staging"
          else
            VERSION="latest"
            ENV="development"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "frontend-tag=ghcr.io/chalidnl/todoless-frontend:$VERSION" >> $GITHUB_OUTPUT
          echo "backend-tag=ghcr.io/chalidnl/todoless-backend:$VERSION" >> $GITHUB_OUTPUT
          echo "Building for environment: $ENV with tag: $VERSION"

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./server
          cache-from: type=gha,scope=backend-${{ steps.meta.outputs.environment }}
          cache-to: type=gha,mode=max,scope=backend-${{ steps.meta.outputs.environment }}
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/chalidnl/todoless-backend:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.version == 'latest' && 'ghcr.io/chalidnl/todoless-backend:latest' || '' }}

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          cache-from: type=gha,scope=frontend-${{ steps.meta.outputs.environment }}
          cache-to: type=gha,mode=max,scope=frontend-${{ steps.meta.outputs.environment }}
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/chalidnl/todoless-frontend:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.version == 'latest' && 'ghcr.io/chalidnl/todoless-frontend:latest' || '' }}

      - name: Comment PR with image tags
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: `âœ… **Integration images built successfully!**
              
              **Frontend**: \`ghcr.io/chalidnl/todoless-frontend:pr-${{ github.event.pull_request.number }}\`
              **Backend**: \`ghcr.io/chalidnl/todoless-backend:pr-${{ github.event.pull_request.number }}\`
              
              Deploy to integration:
              \`\`\`bash
              TAG=pr-${{ github.event.pull_request.number }} docker-compose -f docker-compose.integration.yml up -d
              \`\`\`
              `
            })

      # Fullstack image disabled after reverting to stable two-container architecture.
      # To re-enable later, uncomment this block and ensure docker-compose references the combined image.
      # - name: Build and push fullstack
      #   uses: docker/build-push-action@v6
      #   with:
      #     file: ./Dockerfile.fullstack
      #     context: .
      #     cache-from: type=gha,scope=fullstack
      #     cache-to: type=gha,mode=max,scope=fullstack
      #     platforms: linux/amd64,linux/arm64
      #     push: true
      #     build-args: |
      #       VITE_API_URL=${{ env.FRONTEND_VITE_API_URL }}
      #     tags: |
      #       ghcr.io/chalidnl/todoless:latest
      #       ghcr.io/chalidnl/todoless:${{ steps.meta.outputs.version }}
      #       ghcr.io/chalidnl/todoless:${{ github.sha }}
